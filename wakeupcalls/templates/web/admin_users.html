{% extends "base/base.html" %}
{% load static %}

{% block title %}User Management - Admin{% endblock %}

{% block extra_css %}
<style>
    .admin-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .user-row {
        padding: 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .user-row:last-child { border-bottom: none; }
    .user-info h6 { margin: 0; }
    .user-actions .btn { margin-left: 5px; }
    .admin-nav {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .admin-nav a {
        margin-right: 15px;
        text-decoration: none;
        padding: 8px 16px;
        background: #667eea;
        color: white;
        border-radius: 4px;
        font-size: 0.9em;
    }
    .admin-nav a:hover {
        background: #5a67d8;
        color: white;
    }
    .admin-nav a.active {
        background: #4c51bf;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>ðŸ‘¥ User Management</h1>
        <div>
            <span class="badge badge-primary">{{ user_summary.total_users }} Total</span>
            <span class="badge badge-success">{{ user_summary.verified_users }} Verified</span>
            <span class="badge badge-danger">{{ user_summary.admin_users }} Admins</span>
        </div>
    </div>

    <!-- Admin Navigation -->
    <div class="admin-nav">
        <a href="{% url 'web:admin_dashboard' %}"><i class="bi bi-speedometer2"></i> Dashboard</a>
        <a href="{% url 'web:admin_users' %}" class="active"><i class="bi bi-people"></i> Users</a>
        <a href="{% url 'web:admin_logs' %}"><i class="bi bi-file-text"></i> Logs</a>
        <a href="{% url 'web:admin_demo' %}"><i class="bi bi-database"></i> Demo Data</a>
        <a href="{% url 'admin:index' %}"><i class="bi bi-gear"></i> Django Admin</a>
    </div>

    <!-- Users List -->
    <div class="admin-card">
        <h5><i class="bi bi-people"></i> All Users</h5>
        
        {% for user in users %}
        <div class="user-row">
            <div class="user-info">
                <h6>
                    <a href="{% url 'web:admin_user_detail' user.id %}" class="text-decoration-none">
                        {{ user.email }}
                    </a>
                    {% if user.role == 'admin' %}
                        <span class="badge badge-danger ml-2">Admin</span>
                    {% endif %}
                    {% if not user.is_active %}
                        <span class="badge badge-secondary ml-2">Inactive</span>
                    {% endif %}
                    {% if 'demo' in user.email %}
                        <span class="badge badge-info ml-2">Demo</span>
                    {% endif %}
                </h6>
                <small class="text-muted">
                    <strong>Name:</strong> {{ user.first_name }} {{ user.last_name|default:"" }} | 
                    <strong>Phone:</strong> {{ user.phone_number|default:"Not provided" }}
                    {% if user.phone_verified %}
                        <span class="text-success">âœ“ Verified</span>
                    {% else %}
                        <span class="text-warning">âš  Unverified</span>
                    {% endif %}
                    <br>
                    <strong>Location:</strong> {{ user.zip_code|default:"Not provided" }} ({{ user.timezone }}) | 
                    <strong>Joined:</strong> {{ user.date_joined|date:"M d, Y H:i" }}
                    {% if user.last_login %}
                        | <strong>Last login:</strong> {{ user.last_login|date:"M d, Y H:i" }}
                    {% else %}
                        | <span class="text-muted">Never logged in</span>
                    {% endif %}
                    <br>
                    <strong>Activity:</strong> {{ user.total_calls }} calls ({{ user.active_calls }} active) | 
                    {{ user.total_executions }} executions ({{ user.successful_executions }} successful)
                </small>
            </div>
            
            <div class="user-actions">
                {% if not user.phone_verified %}
                <form method="post" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="verify_phone">
                    <input type="hidden" name="user_id" value="{{ user.id }}">
                    <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Manually verify phone for {{ user.email }}?')">
                        <i class="bi bi-check-circle"></i> Verify Phone
                    </button>
                </form>
                {% endif %}
                
                {% if user.role != 'admin' %}
                <form method="post" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="make_admin">
                    <input type="hidden" name="user_id" value="{{ user.id }}">
                    <button type="submit" class="btn btn-sm btn-warning" onclick="return confirm('Make {{ user.email }} an admin?')">
                        <i class="bi bi-shield-check"></i> Make Admin
                    </button>
                </form>
                {% elif user.id != request.user.id %}
                <form method="post" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="remove_admin">
                    <input type="hidden" name="user_id" value="{{ user.id }}">
                    <button type="submit" class="btn btn-sm btn-outline-warning" onclick="return confirm('Remove admin privileges from {{ user.email }}?')">
                        <i class="bi bi-shield-x"></i> Remove Admin
                    </button>
                </form>
                {% endif %}
                
                {% if user.is_active and user.id != request.user.id %}
                <form method="post" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="deactivate">
                    <input type="hidden" name="user_id" value="{{ user.id }}">
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Deactivate {{ user.email }}?')">
                        <i class="bi bi-person-x"></i> Deactivate
                    </button>
                </form>
                {% elif not user.is_active %}
                <form method="post" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="activate">
                    <input type="hidden" name="user_id" value="{{ user.id }}">
                    <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Activate {{ user.email }}?')">
                        <i class="bi bi-person-check"></i> Activate
                    </button>
                </form>
                {% endif %}
                
                <a href="{% url 'web:admin_user_detail' user.id %}" class="btn btn-sm btn-info">
                    <i class="bi bi-eye"></i> Details
                </a>
                <a href="{% url 'admin:accounts_user_change' user.id %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-pencil"></i> Edit
                </a>
            </div>
        </div>
        {% empty %}
        <p class="text-muted text-center py-4">No users found.</p>
        {% endfor %}
    </div>

    <!-- User Statistics -->
    <div class="row">
        <div class="col-md-6">
            <div class="admin-card">
                <h6><i class="bi bi-bar-chart"></i> User Statistics</h6>
                <p><strong>Total Users:</strong> {{ user_summary.total_users }}</p>
                <p><strong>Verified Users:</strong> {{ user_summary.verified_users }}</p>
                <p><strong>Admin Users:</strong> {{ user_summary.admin_users }}</p>
                <p><strong>Active Users:</strong> {{ user_summary.active_users }}</p>
                <p><strong>Demo Users:</strong> {{ user_summary.demo_users }}</p>
            </div>
        </div>
        <div class="col-md-6">
            <div class="admin-card">
                <h6><i class="bi bi-info-circle"></i> Management Tips</h6>
                <ul class="mb-0">
                    <li><strong>Details:</strong> Click user email to view comprehensive details</li>
                    <li><strong>Phone Verification:</strong> Manually verify if users have SMS issues</li>
                    <li><strong>Admin Rights:</strong> Admins can access all management features</li>
                    <li><strong>Deactivation:</strong> Preserves data while preventing login</li>
                    <li><strong>Django Admin:</strong> Use for advanced user field editing</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}
