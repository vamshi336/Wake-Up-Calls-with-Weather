{% extends "base/base.html" %}
{% load static %}

{% block title %}API Test - Vamshi Wake-up Calls{% endblock %}

{% block extra_css %}
<style>
    .api-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .code-block {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 15px;
        margin: 10px 0;
        font-family: 'Courier New', monospace;
    }
    .method-patch { color: #ffc107; font-weight: bold; }
    .method-get { color: #28a745; font-weight: bold; }
    .method-post { color: #007bff; font-weight: bold; }
    .response-area {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        min-height: 100px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>üß™ API Testing - New Simple Design</h1>
    <p class="lead">Test the improved REST API design</p>

    <!-- API Overview -->
    <div class="api-card">
        <h3>‚úÖ New Simple API Design</h3>
        <p><strong>One endpoint, multiple operations:</strong></p>
        <div class="code-block">
            <span class="method-patch">PATCH</span> /api/wakeup-calls/{id}/ - Update any field(s)<br>
            <span class="method-get">GET</span> /api/wakeup-calls/{id}/ - Get details<br>
            <span class="method-post">POST</span> /api/wakeup-calls/{id}/test-now/ - Test immediately
        </div>
    </div>

    <!-- Test Your Calls -->
    {% if user_calls %}
    <div class="api-card">
        <h3>üéØ Test With Your Wake-up Calls</h3>
        {% for call in user_calls %}
        <div class="border p-3 mb-3 rounded">
            <h5>{{ call.name }} (ID: {{ call.id }})</h5>
            <p><strong>Current Status:</strong> {{ call.status }} | <strong>Time:</strong> {{ call.scheduled_time }} | <strong>Method:</strong> {{ call.contact_method }}</p>
            
            <div class="row">
                <div class="col-md-6">
                    <h6>Test Status Change:</h6>
                    <button class="btn btn-warning btn-sm" onclick="testAPI({{ call.id }}, 'status', 'paused')">
                        Pause Call
                    </button>
                    <button class="btn btn-success btn-sm" onclick="testAPI({{ call.id }}, 'status', 'active')">
                        Activate Call
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="testAPI({{ call.id }}, 'status', 'cancelled')">
                        Cancel Call
                    </button>
                </div>
                <div class="col-md-6">
                    <h6>Test Other Updates:</h6>
                    <button class="btn btn-info btn-sm" onclick="testAPI({{ call.id }}, 'scheduled_time', '08:00:00')">
                        Change Time to 8:00 AM
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="testAPI({{ call.id }}, 'contact_method', 'sms')">
                        Switch to SMS
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="testCall({{ call.id }})">
                        Test Now
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="api-card">
        <h3>üìù No Wake-up Calls Yet</h3>
        <p>Create a wake-up call first to test the API.</p>
        <a href="{% url 'web:create_wakeup_call' %}" class="btn btn-primary">Create Wake-up Call</a>
    </div>
    {% endif %}

    <!-- API Response -->
    <div class="api-card">
        <h3>üì° API Response</h3>
        <div id="response-area" class="response-area">
            Click any button above to see the API response here...
        </div>
    </div>

    <!-- Manual API Testing -->
    <div class="api-card">
        <h3>üîß Manual API Testing</h3>
        <p>Test the API manually with custom requests:</p>
        
        <div class="row">
            <div class="col-md-6">
                <label>Wake-up Call ID:</label>
                <input type="number" id="manual-call-id" class="form-control" placeholder="Enter call ID">
            </div>
            <div class="col-md-6">
                <label>JSON Data:</label>
                <input type="text" id="manual-data" class="form-control" placeholder='{"status": "paused"}'>
            </div>
        </div>
        <div class="mt-3">
            <button class="btn btn-primary" onclick="manualAPITest()">Send PATCH Request</button>
            <button class="btn btn-info" onclick="getCallDetails()">Get Call Details</button>
        </div>
    </div>

    <!-- API Documentation -->
    <div class="api-card">
        <h3>üìö Quick Reference</h3>
        <div class="row">
            <div class="col-md-6">
                <h6>Status Values:</h6>
                <ul>
                    <li><code>"active"</code> - Running normally</li>
                    <li><code>"paused"</code> - Temporarily disabled</li>
                    <li><code>"cancelled"</code> - Permanently stopped</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>Contact Methods:</h6>
                <ul>
                    <li><code>"call"</code> - Voice call</li>
                    <li><code>"sms"</code> - Text message</li>
                </ul>
            </div>
        </div>
        <div class="mt-3">
            <a href="/api/docs/" class="btn btn-outline-primary">Full API Documentation</a>
            <a href="{% url 'web:main_dashboard' %}" class="btn btn-outline-secondary">Back to Dashboard</a>
        </div>
    </div>
</div>

<script>
function testAPI(callId, field, value) {
    const data = {};
    data[field] = value;
    
    updateResponse(`Sending PATCH /api/wakeup-calls/${callId}/\nData: ${JSON.stringify(data, null, 2)}\n\nWaiting for response...`);
    
    fetch(`/api/wakeup-calls/${callId}/`, {
        method: 'PATCH',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        updateResponse(`‚úÖ SUCCESS!\n\nResponse:\n${JSON.stringify(data, null, 2)}`);
        if (data.message) {
            alert('‚úÖ ' + data.message);
        }
    })
    .catch(error => {
        updateResponse(`‚ùå ERROR!\n\n${error.toString()}`);
        console.error('Error:', error);
    });
}

function testCall(callId) {
    updateResponse(`Sending POST /api/wakeup-calls/${callId}/test-now/\n\nWaiting for response...`);
    
    fetch(`/api/wakeup-calls/${callId}/test-now/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        updateResponse(`‚úÖ TEST CALL QUEUED!\n\nResponse:\n${JSON.stringify(data, null, 2)}`);
        if (data.message) {
            alert('‚úÖ ' + data.message);
        }
    })
    .catch(error => {
        updateResponse(`‚ùå ERROR!\n\n${error.toString()}`);
        console.error('Error:', error);
    });
}

function manualAPITest() {
    const callId = document.getElementById('manual-call-id').value;
    const dataStr = document.getElementById('manual-data').value;
    
    if (!callId || !dataStr) {
        alert('Please enter both Call ID and JSON data');
        return;
    }
    
    try {
        const data = JSON.parse(dataStr);
        
        updateResponse(`Sending PATCH /api/wakeup-calls/${callId}/\nData: ${JSON.stringify(data, null, 2)}\n\nWaiting for response...`);
        
        fetch(`/api/wakeup-calls/${callId}/`, {
            method: 'PATCH',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            updateResponse(`‚úÖ SUCCESS!\n\nResponse:\n${JSON.stringify(data, null, 2)}`);
        })
        .catch(error => {
            updateResponse(`‚ùå ERROR!\n\n${error.toString()}`);
        });
    } catch (e) {
        alert('Invalid JSON data: ' + e.message);
    }
}

function getCallDetails() {
    const callId = document.getElementById('manual-call-id').value;
    
    if (!callId) {
        alert('Please enter a Call ID');
        return;
    }
    
    updateResponse(`Sending GET /api/wakeup-calls/${callId}/\n\nWaiting for response...`);
    
    fetch(`/api/wakeup-calls/${callId}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        updateResponse(`‚úÖ CALL DETAILS!\n\nResponse:\n${JSON.stringify(data, null, 2)}`);
    })
    .catch(error => {
        updateResponse(`‚ùå ERROR!\n\n${error.toString()}`);
    });
}

function updateResponse(text) {
    document.getElementById('response-area').textContent = text;
}
</script>
{% endblock %}
